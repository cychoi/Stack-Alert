<!--

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->

<!-- This page displays the popup when the user clicks the action icon -->

<!-- Include our stylesheet and JavaScript utility library -->
<link href="style.css" rel="stylesheet" />
<script src="stackapi.js"></script>

<script>

// This function begins the authorization process.
function Authorize() {
    
    StackAPI.BeginImplicitAuth(chrome.extension.getURL('auth_complete.html'));
    
}

// This function generates an rgb() declaration from 1 or 3 parameters
function GenerateRGB(r, g, b) {
    
    // If either of the other two parameters were not specified,
    // set their values to 'r'.
    if(typeof g == 'undefined')
        g = r;
    if(typeof b == 'undefined')
        b = r;
    
    return 'rgb(' + parseInt(r) + ',' + parseInt(g) + ',' + parseInt(b) + ')';
    
}

// Check to see if we have an access token. If we don't we need to
// let the user know that they need one and provide a button for getting one.
if(localStorage.getItem('access_token') === null) {
    
    document.write('<div class="auth"><p>You need to authorize StackAlert to access your account.</p><button onclick="Authorize();">Authorize Now</button></div>');
    
} else {
    
    // Check to see if the inbox data is available (since the background
    // page should be fetching it periodically).
    var inbox_items = localStorage.getItem('inbox_contents');
    
    if(inbox_items === null)
        document.write('Inbox data is not available at this time.');
    else {
        
        // The inbox data is JSON-encoded so decode it now.
        inbox_items = JSON.parse(inbox_items);
        
        // Begin generating the HTML for the page
        var page_contents = '<h3>Inbox Contents:</h3></p><ul class="contents">';
        
        // The color of the item is determined by this factor
        var color_factor = 0.4;
        
        for(var i=0;i<inbox_items.length;++i) {
            
            // Both the background and text colors begin at a constant value
            // and are modified later according to their position and status.
            var bg    = 32;
            var color = 255;
            
            // If it is unread, slowly scale back its color
            if(!inbox_items[i]['is_unread']) {
            
                if(color_factor <= 0.1)
                    break;
                
                bg    *= color_factor;
                color *= color_factor;
                
                color_factor -= 0.1;
                
            }
            
            // Invert the colors
            bg    = 255 - bg;
            color = 255 - color;
        
            page_contents += '<li style="background-color: ' + GenerateRGB(bg) + '"><a href="' + inbox_items[i]['link'] + '" target="_blank" style="color: ' + GenerateRGB(color) + ';"><span class="title">' + inbox_items[i]['title'] + '</span><span class="body">' + inbox_items[i]['body'] + '</span></a></li>';
            
        }
        
        page_contents += '</ul>';
        document.write(page_contents);
    }
}

</script>